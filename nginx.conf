server {
    listen      80;
    server_name _;

    root  /usr/share/nginx/html;
    index index.html;

    # Serve the SPA â€“ unknown routes fall back to index.html so that
    # client-side routing (React Router) works on a hard refresh.
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Reverse-proxy /api/* requests to the backend.
    # BACKEND_URL must not have a trailing slash (see .env.example).
    location /api/ {
        proxy_pass          ${BACKEND_URL};
        proxy_http_version  1.1;
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        # Strip the Secure attribute from Set-Cookie headers so that
        # httpOnly session cookies work over plain HTTP.
        # nginx is the TLS termination point; the browser-to-nginx leg is
        # already encrypted on HTTPS deployments so the cookie is still
        # protected in transit.
        proxy_cookie_flags ~ nosecure;
    }
}
